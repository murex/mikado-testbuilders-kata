# Easy Fix, Difficult Test

![A pipe fixed with wrenches](images/quick-fix.jpg)

*[Image Source](https://pixabay.com/photos/plumbing-pipe-wrench-plumber-840835/)*

## Here is the sample app

### What does it do?

We own a company that sells Books on-line in various cities around the world. 
To manage our purchases, we have developed an internal system that has two 
portals:

#### 1. Customer Portal

This portal, provides our customers with features allowing them to search for 
and purchase books. 

The purchase workflow is as follows: 
1. Customers add the books they want to purchase to a basket.     
1. They then checkout their basket.
1. Upon checkout, our system should generate an invoice. The invoice should 
have the following properties: 
    1. Tax rates and tax reduction rules should be applied for each item in 
    the basket 
    2. The total amount of the invoice should be the sum of the amount of all 
    books (after tax) in the basket
    3. The currency of the invoice is the same currency as the respective 
    country
1. The Invoice is sent to the customer, and a copy of it is saved in our 
repository for future reference   

>Tip: It is important to note that each country has its own tax rates and tax 
reduction rules. You can find a table of those rules below.  
 
#### 2. Reporting Portal

The second portal is used by administrators to generate reports of the sales 
around the world. 

The report should include the following: 
1. Accumulative sum of all the issued invoices' amount
1. The count of processed invoices 
1. The currency of the report should be in USD 

### Countries, Currencies, Language, Tax Rates, and Tax Reduction Rules   

| Country       | Currency          | Language  | Exchange Rate to USD  | Tax Rate | Tax Reduction Rules                              | 
| :-------------|:-----------------:| :--------:| :--------------------:|:--------:|:------------------------------------------------:|
| USA           | USD               | English   | 1.0                   | 15%      | Reduction by 2% on Novels                        |  
| France        | Euro              | French    | 1.14                  | 25%      | No Reduction on taxes                            | 
| UK            | Pound Sterling    | English   | 1.27                  | 20%      | Reduction by 7% on Novels                        |
| Spain         | Euro              | Spanish   | 1.14                  | 10%      | Removed taxes on all foreign language books      |  
| China         | Renminbi          | Mandarin  | 0.15                  | 35%      | Removed taxes on all foreign language books      |
| Japan         | YEN               | Japanese  | 0.0093                | 30%      | No Reduction on taxes                            |
| Australia     | Australian Dollar | English   | 0.70                  | 13%      | No Reduction on taxes                            |     
| Germany       | Euro              | German    | 1.14                  | 22%      | Dropped to 5% on books written by German Authors |  


### Repository

The repository is our database where we store copies of all the issued invoices. 
The repository is defined by an interface that has 2 methods: 
1. addInvoice: adds an invoice to the repository's database 
1. getInvoiceMap: return all the available invoices in a Map  

Having this interface enables us to have different implementations for our 
database (Json, InMemory, Relational, NoSql, etc). 

In this workshop, we wrote a JSON implementation for this Repository interface
([JsonRepository.java](../java/src/main/java/com/murex/tbw/storage/JsonRepository.java)). 
We assumed that we are storing our data in JSON format in a [file](../java/src/main/resources/repository.json) 
under the resources folder.  

> Tip: Reading the repository.json file might help you understand the structure
of the code faster.  

On initialization, the class parses the Json file and loads the data into a Map.
 
The MainRepository singleton returns the currently configured Repository.

## With a bug!

We noticed that some of the numbers generated by the report are wrong. 

| Report                                  | Actual | Expected | 
|:---------------------------------------:|:------:|:--------:| 
| The total number of books sold          | 16     |  16      |
| The total number of issued invoices     | 6      |  6       |
| The total amount of all invoices in USD | 1016.04|  424.60  |

Fortunately, our great team mates gave us some clues as to the origin of the
problem:

> It looks like conversion rates and tax reductions were not applied.
> [The domain expert]

> It's weird because there is code for these in TaxRule and CurrencyConverter!
> [A senior developer]

## Your mission is to fix the bug and unit test the code 

### 1. Bug Description 

The reporting team provided a scenario to reproduce the bug!  
Under the resources folder, they saved a JSON file ([repository.json](../java/src/main/resources/repository.json)) that contains 
some data issued invoices from previous transactions.

> Tip: The total amount of each invoice is not included in this list. 

The Main class ([Application.java](../java/src/main/java/Application.java)) initializes
an instance of ReportGenerator and then calls the methods to get the 3 report
values: 
1. Total number of books sold
1. Total number of issued invoices
1. Sum of total amount of all invoices

### 2. Tips to Fix the Bugs

After some analysis, one of our developers was able to quickly identify the bugs
in the code and provided us with quick fixes!  

<details>
  <summary markdown='span'>
  Sneak Peek at Bug Fix in Invoice.java
  </summary>

  ```diff
  public double computeTotalAmount() {
    double sum = 0.0;
    for (PurchasedBook purchasedBook : purchasedBooks) {
  -   double totalPrice = purchasedBook.getTotalPrice();
  +   double totalPrice = purchasedBook.getTotalPrice() * TaxRule.getApplicableRate(country, purchasedBook.getBook());
      sum += totalPrice;
    }
    return sum;
  } 
  ```

</details>

<details>
  <summary markdown='span'>
  Sneak Peek at Bug Fix in ReportGenerator.java
  </summary>

  ```diff
      public double getTotalAmount() {
          Map<Integer, Invoice> invoiceMap = repository.getInvoiceMap();
          double totalAmount = 0.0;
          for (Invoice invoice : invoiceMap.values()) {       
  -            totalAmount += invoice.computeTotalAmount();
  +            totalAmount += CurrencyConverter.toUSD(invoice.computeTotalAmount(), invoice.getCountry().getCurrency());
          }
          return totalAmount;
      }
  ```

</details>

<details>
  <summary markdown='span'>
  Sneak Peek at Bug Fix in Invoice.cpp
  </summary>

  ```diff
          double sum = 0.0;
          for (const auto purchasedBook : purchasedBooks_)
          {
  -               double totalPrice = purchasedBook->getTotalPrice();
  +               double totalPrice = purchasedBook->getTotalPrice() * finance::getApplicableRate(country_, *purchasedBook->getBook());
                  sum += totalPrice;
          }
          return sum;
  ```

</details>
   
<details>
  <summary markdown='span'>
  Sneak Peek at Bug Fix in ReportGenerator.cpp
  </summary>

  ```diff java
           double totalAmount = 0.0;
           for (const auto id2Invoice : invoiceMap)
           {
  -                totalAmount += id2Invoice.second->computeTotalAmount();
  +                const auto& invoice = *id2Invoice.second;
  +                totalAmount += finance::toUSD(invoice.computeTotalAmount(), invoice.getCountry().getCurrency());
           }
           return totalAmount;
  ```

</details>

<details>
  <summary markdown='span'>
  Sneak Peek at Bug Fix in Invoice.cs
  </summary>
  
  ```diff c#
      public double ComputeTotalAmount()
      {
          var totalAmount = 0.0;
  -       totalAmount = PurchasedBooks.Sum(book => book.TotalPrice);
  +       totalAmount = PurchasedBooks.Sum(book => book.TotalPrice * TaxRule.GetApplicableRate(Country, book.Book));
          return totalAmount;
      }
  ```
</details>

<details>
  <summary markdown='span'>
  Sneak Peek at Bug Fix in ReportGenerator.cs
  </summary>

  ```diff c#
        public double GetTotalAmount()
        {
            var invoices = _repository.GetInvoiceMap().Values;
  -         var totalAmount = invoices.Sum(invoice => invoice.ComputeTotalAmount());
  +         var totalAmount = invoices.Sum(invoice => CurrencyConverter.ToUsd(invoice.ComputeTotalAmount(), invoice.Country.Currency));
            return totalAmount;
        }
  ```

</details>

### 3. Apply Fixes and Then revert

One approach to fix the problem is to: 
1. Apply the above 2 patches to your code in [Invoice](../java/src/main/java/com/murex/tbw/purchase/Invoice.java) and 
[ReportGenerator](../java/src/main/java/com/murex/tbw/report/ReportGenerator.java) respectively 
1. Re-run the Main class ([Application.java](../java/src/main/java/Application.java))
1. Ensure you see the correct values printed

Now that we know what caused the issue, let's try to do the fix correctly.
We'd like to add a unit test to reproduce the issue first.

So let's revert!

### 3. Write a test on Invoice and only then fix it

Let's add the test to 
[Invoice](../java/src/main/java/com/murex/tbw/purchase/Invoice.java), reproduce the
issue, and fix the code.

Mocking a legacy code base is not a great idea. The only fake we are allowed is
the 
[InMemoryRepository](../src/test/java/com/murex/tbw/storage/InMemoryRepository.java)

### 4. [BONUS] Write a test on ReportGenerator and only then fix it

If you have the time, do the same for
[ReportGenerator](../java/src/main/java/com/murex/tbw/report/ReportGenerator.java):
add a test, reproduce and fix.

## Mini Retro

Take a few minutes to discuss the good and the bad of this approach.

Then compare them to what people usually say in
[Animation Guide.md](./Animation_Guide.md)

---
[Continue...](./3_Building_Test_Data.md)
